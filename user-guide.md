# ANR/Tombstone 智能分析系統使用指南

## 目錄
1. [系統簡介](#系統簡介)
2. [快速開始](#快速開始)
3. [功能介紹](#功能介紹)
4. [最佳實踐](#最佳實踐)
5. [常見問題分析示例](#常見問題分析示例)
6. [外部服務整合](#外部服務整合)
7. [性能優化建議](#性能優化建議)

## 系統簡介

ANR/Tombstone 智能分析系統是一個基於 LLM 的日誌分析平台，專門用於分析 Android 系統的 ANR (Application Not Responding) 和 Tombstone 崩潰日誌。

### 核心特性
- 🚀 **智能分析**：使用 Mistral 7B 模型進行深度分析
- 📊 **RAG 檢索**：基於向量數據庫的相似案例檢索
- 💬 **流式對話**：ChatGPT 風格的實時交互體驗
- 📁 **大文件支持**：可處理高達 2MB 的日誌文件
- 🔗 **外部整合**：支持 Wiki/Outlook/Gerrit/JIRA 查詢
- 🌙 **主題切換**：支持深色/淺色主題

## 快速開始

### 1. 訪問系統
打開瀏覽器，訪問 `http://localhost:8080`

### 2. 上傳日誌文件
點擊左下角的上傳按鈕（📤），選擇您的 ANR 或 Tombstone 文件。支持的格式：
- `.txt`
- `.log`
- `.anr`
- `.tombstone`

### 3. 開始分析
文件上傳後，您可以：
- 使用快速操作按鈕進行常見分析
- 直接輸入問題進行自定義查詢
- 查看系統自動提取的關鍵信息

## 功能介紹

### 📤 文件上傳和分析

1. **智能分塊**
   - 系統會自動識別日誌的關鍵部分
   - 按重要性對內容進行加權處理
   - 保留上下文關係

2. **實時處理**
   ```
   上傳文件 → 智能分塊 → 向量化 → 索引存儲 → 準備就緒
   ```

### 💬 對話交互

1. **上下文記憶**
   - 系統會記住最近 20 條對話
   - 支持連續提問和深入分析
   - 會話持續 1 小時

2. **快速操作**
   - 🔍 分析主線程阻塞
   - 📋 查找死鎖情況
   - ⚡ 生成修復建議
   - 🤖 檢查資源使用

3. **流式回應**
   - 實時顯示分析結果
   - 支持長文本輸出
   - 可隨時中斷

### 🔍 RAG 檢索

系統會自動：
1. 搜索相似的歷史案例
2. 提取相關代碼片段
3. 關聯已知問題和解決方案

## 最佳實踐

### 提問技巧

1. **具體明確**
   ```
   ❌ "有什麼問題？"
   ✅ "請分析主線程在 ActivityThread.handleReceiver 的阻塞原因"
   ```

2. **分步分析**
   ```
   第一步：識別崩潰類型
   第二步：定位具體代碼
   第三步：分析根本原因
   第四步：提供解決方案
   ```

3. **關聯查詢**
   ```
   "這個 ANR 是否與之前的 Issue #12345 相關？"
   "請查找 JIRA 中類似的問題"
   ```

### 文件準備

1. **完整日誌**：確保上傳完整的日誌文件
2. **關鍵信息**：包含進程信息、線程狀態、堆棧跟踪
3. **系統狀態**：CPU/內存使用情況有助於分析

## 常見問題分析示例

### 示例 1：ANR 分析

**問題**：應用主線程無響應

**提問方式**：
```
"請分析這個 ANR 日誌，重點關注：
1. 主線程當前在做什麼
2. 是否有死鎖或長時間阻塞
3. 其他線程的狀態
4. 系統資源使用情況"
```

**系統回應**：
```
基於日誌分析，我發現以下問題：

1. 主線程阻塞位置：
   - 在 ActivityThread.handleReceiver 處理廣播
   - 調用了 ContentResolver.query 進行數據庫查詢
   - 查詢耗時超過 5 秒導致 ANR

2. 根本原因：
   - 數據庫查詢沒有使用索引
   - 查詢結果集過大（超過 10000 條）
   - 在主線程執行了耗時操作

3. 解決建議：
   - 將數據庫查詢移到後台線程
   - 為查詢字段添加索引
   - 使用分頁加載數據
   - 考慮使用 LoaderManager 或 ViewModel

4. 代碼示例：
   [提供具體的修復代碼]
```

### 示例 2：Tombstone 分析

**問題**：Native 崩潰

**提問方式**：
```
"分析這個 tombstone 文件：
1. 崩潰的具體位置和原因
2. 內存訪問是否異常
3. 是否有內存洩漏跡象
4. 提供調試建議"
```

## 外部服務整合

### Wiki 搜索
```
"在 Wiki 中搜索 'ANR handling best practices'"
```

### JIRA 查詢
```
"查找 JIRA 中標記為 'ANR' 的未解決問題"
```

### Gerrit 代碼審查
```
"搜索 Gerrit 中最近關於 BroadcastReceiver 的修改"
```

### Outlook 郵件
```
"搜索關於 'app crash' 的最近郵件討論"
```

## 性能優化建議

### 1. 大文件處理
- 系統自動進行分塊處理
- 建議文件大小不超過 2MB
- 超大文件可以先進行預處理

### 2. 查詢優化
- 使用具體的關鍵詞
- 避免過於寬泛的查詢
- 利用快速操作按鈕

### 3. 模型選擇
- **默認模型**：mistral:7b（平衡速度和質量）
- **代碼分析**：codellama:7b（更好的代碼理解）
- **快速回應**：qwen2:0.5b（犧牲質量換取速度）

## 鍵盤快捷鍵

- `Enter`：發送消息
- `Shift + Enter`：換行
- `Ctrl + K`：清空輸入框
- `Ctrl + L`：清空對話歷史
- `Ctrl + D`：切換主題

## 故障排除

### 問題：文件上傳失敗
**解決方案**：
1. 檢查文件大小（不超過 100MB）
2. 確認文件格式正確
3. 查看瀏覽器控制台錯誤

### 問題：回應速度慢
**解決方案**：
1. 檢查網絡連接
2. 考慮使用快速模型
3. 減少查詢複雜度

### 問題：分析結果不準確
**解決方案**：
1. 提供更完整的日誌
2. 使用更具體的提問
3. 嘗試分步分析

## 進階功能

### 批量分析
```python
# 使用 API 進行批量分析
import requests

files = ['anr1.log', 'anr2.log', 'anr3.log']
for file in files:
    response = requests.post(
        'http://localhost:8080/api/upload',
        files={'file': open(file, 'rb')}
    )
    print(f"{file}: {response.json()}")
```

### 自定義提示詞
```
"使用以下模板分析：
1. 問題摘要：[一句話描述]
2. 影響範圍：[受影響的功能]
3. 根本原因：[技術細節]
4. 解決方案：[具體步驟]
5. 預防措施：[長期建議]"
```

### 導出分析報告
- 點擊對話旁的導出按鈕
- 選擇格式（Markdown/PDF/HTML）
- 包含完整的分析過程和結果

## 更新日誌

### v1.0.0 (2024-12)
- 初始版本發布
- 支援 ANR/Tombstone 分析
- RAG 檢索功能
- 外部服務整合

### 計劃功能
- 批量文件處理
- 分析報告模板
- 團隊協作功能
- 自動化工作流程

## 聯繫支持

如有問題或建議，請通過以下方式聯繫：
- 提交 Issue：[GitHub Issues]
- 郵件：support@example.com
- 內部 Wiki：[ANR Analyzer Documentation]

---

💡 **提示**：定期更新模型和知識庫可以提高分析準確性！